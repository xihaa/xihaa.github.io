# xii的实习日记Day023

## js写法

情景：



```
<template>
  <div class="create-panorama-container">
    <div class="show-3d" id="canvas-container">
      <div :id="canvasId" />
    </div>
    <div class="top-operate-container">
      <div class="top-operate">
        <button class="btn-top save" @click="savePanorama">{{ $t('global_save') }}</button>
        <button class="btn-top exit" @click="exitPanorama">{{ $t('global_exit') }}</button>
      </div>
    </div>
    <div class="operate">
      <div class="btn-material" @click="showMaterial = !showMaterial">
        {{ $t('global_material') }}
      </div>
      <div class="material-operate" v-show="showMaterial">
        <label class="operate-label">{{ $t('global_material_type') }}</label>
        <div class="choose-model" @click="chooseClothingModel">{{ $t('global_clothing_model') }}</div>
        <div class="line"></div>
        <label class="operate-label">{{ $t('global_material_operate') }}</label>
        <div v-for="(item, index) in buttonList" :key="index">
          <div v-if="item.dataType === 'checkbox'">
            <!-- <label>
              {{ $t($t(item.t)) }}
            </label> -->
            <Checkbox v-model="istogglePlace" @on-change="item.method">{{ $t($t(item.t)) }}</Checkbox>
          </div>
          <div v-else class="btn-operate" :key="item.type" @click="buttonIconOper($event, item)">{{ $t(item.t) }}</div>
        </div>
        <div class="cancel-operate" @click="showMaterial = false">{{ $t('global_cancel') }}</div>
      </div>
    </div>
    <div v-if="materialModalConfig && materialModalConfig.visible">
      <materialModal
        :configs="materialModalConfig"
        @on-ok="materialModalok"
        @on-cancel="materialModalConfig.visible = false"
      />
    </div>
    <Spin fix v-if="showLoading" />
  </div>
</template>

<script>
let Lt3D = window['Lt3D']?.default;
import materialModal from '@/components/materialModal';
import { getCommunalSKProductList } from 'lt-service/design/publicdesign';

export default {
  name: 'createPanorama',
  props: ['createPanoramaParams', 'panoramaParams'],
  components: {
    materialModal
  },
  data() {
    return {
      canvasId: 'canvas',
      showLoading: false,
      showMaterial: true,
      materialModalConfig: {
        visible: false,
        loading: false,
        type: 'radio',
        title: this.$t('global_sk_product_public'),
        getList: getCommunalSKProductList,
        materialType: 'style',
        parms: { mode: 'link_mode' },
        // postXhr: postDesignFolderManageCopy,
        callbackMethod: 'addClothingModel'
      },
      istogglePlace: true,
      buttonList: [
        {
          type: 'togglePlace',
          dataType: 'checkbox',
          t: '可拖动摆放',
          name: '可拖动摆放',
          checked: true,
          method: 'togglePlace',
          show: true,
          isCheckbox: true
        },
        {
          type: 'clearModel',
          t: '删除选中素材',
          name: '删除选中素材',
          checked: false,
          method: 'clearModel',
          show: true
        },
        {
          type: 'clearModelData',
          t: '清空素材',
          name: '清空素材',
          checked: false,
          method: 'clearModelData',
          show: true
        }
      ]
    };
  },
  async created() {
    // 初始化
    if (!Lt3D) {
      this.showLoading = true;
      await this.$import3d();
      Lt3D = window['Lt3D']?.default;
    }
  },
  mounted() {
    this.showCanvas();
    this.loadPanorama();
  },
  beforeDestroy() {
    // 销毁
    this.lincpro?.dispose();
  },
  methods: {
    async showCanvas() {
      this.showLoading = true;
      this.lincpro = new Lt3D({
        containerId: this.canvasId,
        dracoDirectory: '/draco/'
      });

      await this.lincpro.setPanorama(true);
      this.showLoading = false;
    },
    loadPanorama() {
      this.$nextTick(() => {
        try {
          this.showLoading = true;
          // this.lincpro.loadPanoramaEditScene({
          //   id: 6086,
          //   src:
          //     'https://lt3d.oss-cn-hangzhou.aliyuncs.com/Fashion/Company/0525f428-eaa5-49da-b1a5-3e80fa1cda46/resource/product/models/20200519193020_3121_hongdan/4tgAmWh9uBOLPptifVRnonw7/sco.json'
          // });
          this.lincpro.loadPanoramaEditScene({
            id: this.createPanoramaParams.id,
            src: this.createPanoramaParams.src
          });
          this.showLoading = false;
        } catch (error) {
          this.showLoading = false;
        }
      });
    },
    chooseClothingModel() {
      this.materialModalConfig.visible = true;
    },
    //加载服饰模型
    async addClothingModel({ userProduct, id, callback }) {
      let clothInfo = userProduct.clothings[id].clothInfo;
      if (clothInfo.hasOwnProperty('data')) delete clothInfo.data;
      try {
        this.showLoading = true;
        await this.lincpro.loadPanoramaLtcloth(clothInfo);
        this.showLoading = false;
        callback && callback();
      } catch (error) {
        this.showLoading = false;
      }
    },
    // 按钮事件监听
    buttonIconOper(event, item) {
      if (item.isCheckbox) {
        item.checked = !item.checked;
      }
      if (this[item.method]) {
        this[item.method]({ event, item });
      } else {
        console.error('还未配置method');
      }
    },
    //设置拖动摆放
    togglePlace() {
      this.lincpro.setTransformCloth(this.istogglePlace);
    },
    // 清除模型数据
    clearModelData() {
      this.lincpro.deletePanoramaCloth();
    },
    clearModel() {
      this.lincpro.deleteSelectedPanoramaCloth();
    },
    // 保存全景
    async savePanorama() {
      this.showLoading = true;

      // 取消摆放
      let togglePlaceItem = this.buttonList.filter(i => i.type === 'togglePlace')[0];
      togglePlaceItem.checked = false;
      this.togglePlace({ item: togglePlaceItem });

      // 下载
      let blob = await this.lincpro.savePanoramaTextures();

      this.panoramaParams.isSaved = true;
      this.panoramaParams.blob = blob;

      this.showLoading = false;
      this.$emit('on-close', this.panoramaParams);
    },
    exitPanorama() {
      this.$emit('on-close');
    },
    materialModalok({ selectedIds }) {
      // console.log('selectedIds', selectedIds);
      this.materialModalConfig.loading = true;
      this[this.materialModalConfig.callbackMethod]({
        userProduct: selectedIds[0].user_product,
        id: selectedIds[0].id,
        callback: err => {
          this.materialModalConfig.loading = false;
          if (!err) {
            this.materialModalConfig.visible = false;
            this.materialModalConfig.selectedValue = [];
          }
        }
      });
    }
  }
};
</script>

<style lang="less" scoped>
.create-panorama-container {
  .show-3d {
    position: relative;
    width: 100%;
    height: 100vh;
    #canvas {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      canvas {
        position: relative;
      }
    }
  }
  .top-operate-container {
    position: fixed;
    top: 0;
    width: 100%;
    height: 60px;
    line-height: 60px;
    background-color: #000000;
  }
  .top-operate {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 10;
    font-size: 14px;
    .btn-top {
      width: 64px;
      height: 34px;
      color: #ffffff;
      margin-right: 20px;
      line-height: 34px;
      &.save {
        background-color: #1e9fff;
      }
      &.exit {
        background-color: #666;
      }
    }
  }
  .operate {
    position: absolute;
    top: 70px;
    right: 20px;
    z-index: 10;
    .btn-material {
      width: 80px;
      height: 30px;
      line-height: 30px;
      color: #ffffff;
      font-size: 12px;
      margin: 0 0 10px 160px;
      background-color: transparent;
      text-align: center;
      border-radius: 2px;
      background: #000000;
      opacity: 0.8;
      border: 1px solid #848484;
      box-shadow: rgba(255, 255, 255, 0.6) 0px 0px 4px;
      &:hover {
        background-color: #1e9fff;
        border: none;
      }
    }
    .material-operate {
      width: 240px;
      height: 288px;
      padding: 20px;
      font-size: 12px;
      line-height: 24px;
      background-color: #000000;
      opacity: 0.8;
      color: #ffffff;
      .choose-model {
        width: 80px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        background: #1e9fff;
        font-size: 12px;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .operate-label {
        display: inline-block;
        margin-bottom: 12px;
        font-size: 14px;
      }
      .line {
        width: 100%;
        height: 1px;
        background: #c7c7c7;
        margin: 20px 0;
      }
      .btn-operate {
        padding: 0 16px;
        display: inline-block;
        font-size: 12px;
        height: 28px;
        line-height: 28px;
        background: #000000;
        color: #ffffff;
        opacity: 0.8;
        margin-top: 12px;
        border: 1px solid #1e9fff;
        border-radius: 2px;
        &:hover {
          background-color: #1e9fff;
        }
      }
    }
    .cancel-operate {
      width: 240px;
      height: 32px;
      line-height: 32px;
      color: #ffffff;
      font-size: 12px;
      text-align: center;
      background: #000000;
      position: absolute;
      right: 0px;
    }
  }
}
</style>

```





```
<template>
  <div class="vr-container" ref="vrContainer">
    <Tabs v-model="tabValue" @on-click="onTabClick">
      <TabPane v-for="tab in tabs" :key="tab.name" :name="tab.name" :label="tab.label" />
    </Tabs>
    <!-- 列表 -->
    <iframe
      ref="iframe"
      :src="url.list"
      :key="url.list"
      width="100%"
      height="100%"
      frameborder="0"
      scrolling="auto"
    ></iframe>

    <!-- 编辑 -->
    <div class="vr-edit-container" v-if="url.edit">
      <iframe :src="url.edit" width="100%" height="100%" frameborder="0" scrolling="auto"></iframe>
      <div v-if="materialModalConfig.visible">
        <materialModal
          :configs="materialModalConfig.configs"
          @on-ok="materialModalok"
          @on-cancel="materialModalConfig.visible = false"
        />
      </div>
    </div>
    <!-- 自定义创建场景设计 -->
    <div class="vr-edit-container" v-if="createPanoramaParams.showCreatePanorama">
      <createPanorama
        ref="createPanoramaRef"
        :createPanoramaParams="createPanoramaParams.configParam"
        :panoramaParams="panoramaParams"
        @on-close="panoramaExit"
      />
    </div>
    <!-- 选择场景模板创建全景 -->
    <div v-if="panoramaModalConfig.visible">
      <materialModal
        :configs="panoramaModalConfig"
        @on-ok="panoramaModalok"
        @on-cancel="panoramaModalConfig.visible = false"
      />
    </div>
    <!-- <div class="vr-edit-container" v-if="url.view">
      <iframe :src="url.view" width="100%" height="100%" frameborder="0" scrolling="auto"></iframe>
    </div> -->
  </div>
</template>

<script>
import { indexMixin } from '@/mixins/common/indexMixin';
import Store from 'store';
import materialModal from '@/components/materialModal';
import {
  postCreateSkProductShareUrl,
  postCreateSkProductDashboardShareUrl,
  postCreateFabricDashboardShareUrl
} from 'lt-service/design/workspace';
import { getCommunalSKProductList } from 'lt-service/design/publicdesign';
import { getFabricList, postCreateShareUrl as postCreateFabricShareUrl } from 'lt-service/resource/fabric';
import { getCommunalSkProductDashboardList } from 'lt-service/design/publicdesign';
import { getCommunalFabricDashboardList } from 'lt-service/design/publicdesign';
import { postHallShare } from 'lt-service/business/hall';
import createPanorama from '@/components/3d/vr/createPanorama';
import { getCreatePanorama } from 'lt-service/vr/index';

export default {
  components: {
    materialModal,
    createPanorama
  },
  mixins: [indexMixin],
  data() {
    return {
      url: {
        list: '',
        edit: '',
        view: ''
      },
      tabValue: 'panoramic',
      tabs: [
        { name: 'panoramic', label: this.$t('global_vr_panoramic'), listUrl: '/member/index/zpindex' },
        { name: 'resource', label: this.$t('global_res_library'), listUrl: '/member/material/panoview' }
      ],
      page: '', // 区分页面，不同页面显示的资源弹框不同
      materialModalConfig: {
        visible: false,
        action: 'toGetMaterials',
        configs: []
      },
      panoramaModalConfig: {
        visible: false,
        loading: false,
        type: 'radio',
        title: this.$t('global_choose_scene'),
        getList: getCreatePanorama,
        materialType: 'style',
        parms: { mode: 'link_mode' },
        // postXhr: postDesignFolderManageCopy,
        callbackMethod: 'createPanorama'
      },
      getResourceInfoObj: {
        selectProduct: {
          configs: [
            {
              title: this.$t('global_add_product_hot_spot'),
              getList: getCommunalSKProductList,
              materialType: 'product',
              selectedValue: [], // 已选中的值
              excludeValue: [],
              selectedParms: {}, // 已筛选的筛选项
              parms: { mode: 'image_mode' },
              type: 'radio',
              extra: {
                routePage: 'style',
                type: 'selectProduct',
                func: 'desdpskproduct',
                shareXhr: postCreateSkProductShareUrl
              }
            }
          ]
        },
        selectFabric: {
          configs: [
            {
              title: this.$t('global_add_fabric_hot_spot'),
              getList: getFabricList,
              materialType: 'fabric',
              selectedValue: [], // 已选中的值
              excludeValue: [],
              selectedParms: {}, // 已筛选的筛选项
              parms: { mode: 'image_mode' },
              type: 'radio',
              extra: {
                routePage: 'fabric',
                type: 'selectFabric',
                func: 'resfabric',
                shareXhr: postCreateFabricShareUrl
              }
            }
          ]
        },
        selectProductDashboard: {
          configs: [
            {
              title: this.$t('global_add_dashboard_hot_spot'),
              getList: getCommunalSkProductDashboardList,
              materialType: 'dashboard',
              selectedValue: [], // 已选中的值
              excludeValue: [],
              selectedParms: {}, // 已筛选的筛选项
              parms: { mode: 'image_mode' },
              type: 'radio',
              extra: {
                routePage: 'dashboard',
                type: 'selectProductDashboard',
                func: 'dsproductboard',
                shareXhr: postCreateSkProductDashboardShareUrl
              }
            }
          ]
        },
        selectFabricDashboard: {
          configs: [
            {
              title: this.$t('global_add_dashboard_hot_spot'),
              getList: getCommunalFabricDashboardList,
              materialType: 'dashboard',
              selectedValue: [], // 已选中的值
              excludeValue: [],
              selectedParms: {}, // 已筛选的筛选项
              parms: { mode: 'image_mode' },
              type: 'radio',
              extra: {
                routePage: 'dashboard',
                type: 'selectFabricDashboard',
                func: 'dsfabricboard',
                shareXhr: postCreateFabricDashboardShareUrl
              }
            }
          ]
        }
      },
      iframeEvent: '',
      // 自定创建全景设计
      createPanoramaParams: {
        showCreatePanorama: false,
        configParam: {
          id: '',
          src: ''
        }
      },
      //全景参数 传递给vr
      panoramaParams: {
        isSaved: false,
        blob: ''
      }
    };
  },
  mounted() {
    this.onTabClick(this.tabValue);
    window.addEventListener('message', this.receiveVrMessage);

    // 前端自行测试代码， 选款
    // setTimeout(() => {
    //   console.log('mounted');
    //   this.receiveVrMessage({
    //     data: {
    //       from: 'vr',
    //       type: 'selectFabricShowroom'
    //     }
    //   });
    // }, 10000);
  },
  beforeDestroy() {
    window.removeEventListener('message', this.receiveVrMessage);
  },
  methods: {
    onTabClick(name) {
      const resUrl = this.tabs.find(el => el.name === this.tabValue).listUrl;
      this.url.list = `${this.$G.iframe.vr[process.env.VUE_APP_ENV]}${resUrl}?token=${Store.get(
        this.$G.store.token
      )}&from=style3d&page=${this.page}`;
    },
    /**
     * 和 vr 通信
     */
    receiveVrMessage(e) {
      // TODO 后续改为 origin 判断来源
      if (e.data.from == 'vr') {
        if (e.data.type == 'isCloud') {
          e.source.postMessage(
            {
              from: 'style3d',
              type: 'isStyle3d',
              state: true
            },
            e.origin
          );
        }
        // 获取用户信息，暂不使用
        if (e.data.type == 'userInfo') {
          e.source.postMessage(
            {
              from: 'style3d',
              type: 'userInfo',
              data: {
                userInfo: Store.get(this.$G.store.userInfo)
              }
            },
            e.origin
          );
        }
        if (e.data.type == 'createLimit') {
          this.$Modal.warning({
            title: this.$t('global_capped_payment', { str: this.$t('global_scene_num') }),
            content: this.$t('global_capped_payment_tip', {
              str: this.$G.const.SERVICE_TEL
            })
          });
        }
        // 编辑，进入全屏编辑
        if (e.data.type == 'edit') {
          this.materialModalConfig.visible = false;
          this.url.edit = e.data.data.url + `?token=${Store.get(this.$G.store.token)}&from=style3d&page=${this.page}`;
        }
        // 关闭编辑，返回列表
        if (e.data.type == 'closeEdit') {
          this.materialModalConfig.visible = false;
          this.url.edit = '';
        }
        // 查看，暂不使用
        if (e.data.type == 'view') {
          this.url.view = e.data.data.url + `?token=${Store.get(this.$G.store.token)}&from=style3d&page=${this.page}`;
        }
        // 款式、面料、看板、展厅 选择
        if (
          ['selectProduct', 'selectFabric', 'selectProductDashboard', 'selectFabricDashboard'].includes(e.data.type)
        ) {
          this.materialModalConfig = {
            ...this.materialModalConfig,
            ...this.getResourceInfoObj[e.data.type],
            visible: true
          };
          this.iframeEvent = e;
        }
        if (['selectProductShowroom', 'selectFabricShowroom'].includes(e.data.type)) {
          const funcMap = {
            selectProductShowroom: 'product',
            selectFabricShowroom: 'fabric'
          };
          const resTypeMap = {
            selectProductShowroom: 'sk_product',
            selectFabricShowroom: 'fabric'
          };
          let func = funcMap[e.data.type];
          let resType = resTypeMap[e.data.type];
          this.materialModalok({
            selectedIds: [{}],
            config: { extra: { func, resType, shareXhr: postHallShare, routePage: '', type: e.data.type } }
          });
          this.iframeEvent = e;
        }
        //自定义创建场景模板选择
        if (e.data.type == 'designPanorama') {
          if (e.data.data.isOpen) {
            this.panoramaModalConfig.visible = true;
          }
          this.iframeEvent = e;
        }
      }
    },
    /**
     * 选中款式，生成分享链接
     */
    async materialModalok({ selectedIds, config }) {
      if (!selectedIds.length) {
        return this.$Message.warning(this.$t('global_select_style'));
      }
      let item = selectedIds[0];
      const url = await this.createShareUrl({ item, config });
      this.materialModalConfig.visible = false;
      this.iframeEvent.source.postMessage(
        {
          from: 'style3d',
          type: 'share',
          data: {
            url,
            selectedItem: item
          }
        },
        this.iframeEvent.origin
      );
    },
    listChangeType({ type } = {}) {
      this.activeKey = this.$route.params.categoryType;

      if (this.$route.path != `${this.$G.route[this.formInfo.name]}/${type}`) {
        this.$router.push(`${this.$G.route[this.formInfo.name]}/${type}`);
      }
    },
    async createShareUrl({ item = {}, config = {} }) {
      let url = '';
      const { func, shareXhr, routePage, type, resType } = config.extra || {};
      let params = {
        pid: item.id, // 款式
        scopeVersion: item.scopeVersion, // 款式
        id: item.id,
        resType,
        showLogo: 1, // 显示企业log
        type: 0, // 公开
        limit: 0 // 永久
      };
      const res = await shareXhr(params);
      if (['selectProduct', 'selectFabric'].includes(type)) {
        url = `${origin}/${routePage}/${item.id}?share_state_id=${res.data.shareId}&func=${func}&is_share_page=1`;
      } else if (['selectProductDashboard', 'selectFabricDashboard'].includes(type)) {
        url = `${origin}/${routePage}/${res.data.dashboardId}?share_state_id=${res.data.shareId}&func=${func}&&mode_from=dashboard`;
      } else if (['selectProductShowroom', 'selectFabricShowroom'].includes(type)) {
        url = `${origin}/showroom/${res.data.encryptId}?shareFunc=${func}`;
      }
      console.log('createShareUrl', url);
      return url;
    },
    createPanorama({ id, url }) {
      this.createPanoramaParams.configParam.id = parseInt(id);
      this.createPanoramaParams.configParam.src = url;
      console.log('createPanorama', this.createPanoramaParams.configParam);
      this.createPanoramaParams.showCreatePanorama = true;
      this.panoramaModalConfig.visible = false;
      this.panoramaModalConfig.selectedValue = [];
    },
    panoramaModalok({ selectedIds }) {
      console.log('selectedIds', selectedIds);
      this[this.panoramaModalConfig.callbackMethod](selectedIds[0]);
    },
    panoramaExit(params) {
      if (params && params.isSaved) {
        console.log('params', params);
        this.iframeEvent.source.postMessage(
          {
            from: 'style3d',
            type: 'panoramaBlob',
            data: {
              blob: params.blob
            }
          },
          this.iframeEvent.origin
        );
      }
      this.createPanoramaParams.showCreatePanorama = false;
    }
  }
};
</script>

<style lang="less" scoped>
.vr-container {
  height: 100%;
  .vr-edit-container {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    width: 100vw;
    height: 100vh;
    background-color: #fff;
  }
}
</style>

```



```
import xhr from 'lt-xhr';

export const getCreatePanorama = param => xhr('get', '/resource/vr/custom_vr/index', param);

```

